<!DOCTYPE html>
<html lang="rw">
<head>
  <meta charset="UTF-8">
  <title>Muganga AI - Admin Dashboard (v2)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background-color: #f4f6f9; }
    .sidebar { height: 100vh; position: fixed; width: 250px; background-color: #007bff; color: white; }
    .sidebar a { color: white; display: block; padding: 15px; text-decoration: none; }
    .sidebar a:hover { background-color: #0056b3; }
    .content { margin-left: 250px; padding: 20px; }
  </style>
</head>
<body>

  <div class="sidebar">
    <h3 class="text-center py-4">Muganga AI Admin</h3>
    <a href="#" onclick="loadOverview()">Dashboard</a>
    <a href="#" onclick="loadUsers()">Users</a>
    <a href="#" onclick="loadAdmins()">Manage Admins</a>
    <a href="#" onclick="loadRecords()">Health Records</a>
    <a href="#" onclick="loadCritical()">Critical Patients</a>
    <a href="#" onclick="logout()">Logout</a>
  </div>

  <div class="content">
    <h2 id="title">Welcome Admin</h2>
    <div id="dataSection">Loading...</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, getDocs, query, where, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDg3UPQARAGjWdwF53vJIwYOCA7hOIfG1s",
      authDomain: "muganga-ai.firebaseapp.com",
      projectId: "muganga-ai",
      storageBucket: "muganga-ai.appspot.com",
      messagingSenderId: "609789687173",
      appId: "1:609789687173:web:04b6b1eeb20cc70062c0ec",
      measurementId: "G-JSTCX5WQ31"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const title = document.getElementById("title");
    const dataSection = document.getElementById("dataSection");

    onAuthStateChanged(auth, async user => {
      if (user) {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        if (!userDoc.exists() || userDoc.data().role !== "admin") {
          alert("Access Denied");
          logout();
        } else {
          loadOverview();
        }
      } else {
        window.location.href = "admin-login.html";
      }
    });

    window.loadOverview = async function () {
      title.innerText = "Dashboard Overview";
      dataSection.innerHTML = "Loading...";
      const usersSnap = await getDocs(collection(db, "users"));
      const recordsSnap = await getDocs(collection(db, "healthRecords"));
      const criticalSnap = await getDocs(query(collection(db, "healthRecords"), where("temperature", ">", 39)));

      dataSection.innerHTML = `
        <div class='row'>
          <div class='col-md-3'><div class='card p-3 mb-3 bg-primary text-white'><h5>Users</h5><h2>${usersSnap.size}</h2></div></div>
          <div class='col-md-3'><div class='card p-3 mb-3 bg-success text-white'><h5>Health Records</h5><h2>${recordsSnap.size}</h2></div></div>
          <div class='col-md-3'><div class='card p-3 mb-3 bg-danger text-white'><h5>Critical Patients</h5><h2>${criticalSnap.size}</h2></div></div>
        </div>`;
    }

    window.loadUsers = async function () {
      title.innerText = "All Users";
      dataSection.innerHTML = "Loading...";
      const snapshot = await getDocs(collection(db, "users"));
      let html = `<table class='table'><tr><th>Name</th><th>Email</th><th>Role</th></tr>`;
      snapshot.forEach(doc => {
        const d = doc.data();
        html += `<tr><td>${d.name}</td><td>${d.email}</td><td>${d.role}</td></tr>`;
      });
      html += `</table>`;
      dataSection.innerHTML = html;
    }

    window.loadAdmins = async function () {
      title.innerText = "Manage Admins";
      dataSection.innerHTML = "Loading...";
      const snapshot = await getDocs(collection(db, "users"));
      let html = `<table class='table'><tr><th>Name</th><th>Email</th><th>Role</th><th>Actions</th></tr>`;
      snapshot.forEach(docRef => {
        const d = docRef.data();
        html += `<tr>
          <td>${d.name}</td>
          <td>${d.email}</td>
          <td>${d.role}</td>
          <td>
            ${d.role === "admin" 
              ? `<button class='btn btn-sm btn-danger' onclick="changeRole('${docRef.id}', 'patient')">Remove Admin</button>` 
              : `<button class='btn btn-sm btn-success' onclick="changeRole('${docRef.id}', 'admin')">Make Admin</button>`
            }
          </td>
        </tr>`;
      });
      html += `</table>`;
      dataSection.innerHTML = html;
    }

    window.changeRole = async function (userId, role) {
      await updateDoc(doc(db, "users", userId), { role });
      alert("Role updated successfully");
      loadAdmins();
    }

    window.loadRecords = async function () {
      title.innerText = "All Health Records";
      dataSection.innerHTML = "Loading...";
      const snapshot = await getDocs(query(collection(db, "healthRecords"), orderBy("recordedAt", "desc")));
      let html = `<table class='table'><tr><th>Date</th><th>Heart Rate</th><th>Temp</th><th>Weight</th><th>Height</th></tr>`;
      snapshot.forEach(doc => {
        const d = doc.data();
        const date = d.recordedAt?.toDate()?.toLocaleDateString() ?? "N/A";
        html += `<tr>
          <td>${date}</td>
          <td>${d.heartRate} bpm</td>
          <td>${d.temperature}°C</td>
          <td>${d.weight} kg</td>
          <td>${d.height} cm</td>
        </tr>`;
      });
      html += `</table>`;
      dataSection.innerHTML = html;
    }

    window.loadCritical = async function () {
      title.innerText = "Critical Patients";
      dataSection.innerHTML = "Loading...";
      const snapshot = await getDocs(query(collection(db, "healthRecords"), where("temperature", ">", 39)));
      let html = `<table class='table'><tr><th>Date</th><th>Heart Rate</th><th>Temp</th><th>Weight</th><th>Height</th></tr>`;
      snapshot.forEach(doc => {
        const d = doc.data();
        const date = d.recordedAt?.toDate()?.toLocaleDateString() ?? "N/A";
        html += `<tr>
          <td>${date}</td>
          <td>${d.heartRate} bpm</td>
          <td>${d.temperature}°C</td>
          <td>${d.weight} kg</td>
          <td>${d.height} cm</td>
        </tr>`;
      });
      html += `</table>`;
      dataSection.innerHTML = html;
    }

    window.logout = async function () {
      await signOut(auth);
      window.location.href = "admin-login.html";
    }
  </script>

</body>
</html>
