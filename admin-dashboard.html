<!DOCTYPE html>
<html lang="rw">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Muganga AI - Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; background-color: #f4f6f9; }
    .sidebar {
      background-color: #007bff;
      color: white;
      padding-top: 1rem;
      height: 100vh;
    }
    .sidebar a {
      color: white;
      padding: 10px 15px;
      display: block;
      text-decoration: none;
    }
    .sidebar a:hover {
      background-color: #0056b3;
    }
    .sidebar h3 {
      padding-bottom: 1rem;
    }
    @media (min-width: 768px) {
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 250px;
      }
      .content {
        margin-left: 250px;
      }
    }
  </style>
</head>
<body>

<div class="container-fluid">
  <div class="row flex-nowrap">
    <!-- Sidebar -->
    <div class="col-12 col-md-3 col-lg-2 sidebar">
      <h3 class="text-center">Muganga AI Admin</h3>
      <a href="#" onclick="loadOverview()">Dashboard</a>
      <a href="#" onclick="loadUsers()">Users</a>
      <a href="#" onclick="loadAdmins()">Manage Admins</a>
      <a href="#" onclick="loadRecords()">Health Records</a>
      <a href="#" onclick="loadCritical()">Critical Patients</a>
      <a href="#" onclick="logout()">Logout</a>
    </div>

    <!-- Main content -->
    <div class="col content p-4">
      <h2 id="title">Welcome Admin</h2>
      <div id="dataSection">Loading...</div>
    </div>
  </div>
</div>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDg3UPQARAGjWdwF53vJIwYOCA7hOIfG1s",
    authDomain: "muganga-ai.firebaseapp.com",
    projectId: "muganga-ai",
    storageBucket: "muganga-ai.appspot.com",
    messagingSenderId: "609789687173",
    appId: "1:609789687173:web:04b6b1eeb20cc70062c0ec"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  auth.onAuthStateChanged(user => {
    if (user) {
      db.collection("users").doc(user.uid).get().then(doc => {
        if (!doc.exists || doc.data().role !== "admin") {
          alert("Access Denied");
          logout();
        } else {
          loadOverview();
        }
      });
    } else {
      window.location.href = "admin-login.html";
    }
  });

  function loadOverview() {
    document.getElementById("title").innerText = "Dashboard Overview";
    Promise.all([
      db.collection("users").get(),
      db.collection("healthRecords").get(),
      db.collection("healthRecords").where("temperature", ">", 39).get()
    ]).then(([usersSnap, recordsSnap, criticalSnap]) => {
      document.getElementById("dataSection").innerHTML = `
        <div class='row g-3'>
          <div class='col-12 col-md-4'>
            <div class='card text-white bg-primary'>
              <div class='card-body text-center'>
                <h5 class='card-title'>Users</h5>
                <h2>${usersSnap.size}</h2>
              </div>
            </div>
          </div>
          <div class='col-12 col-md-4'>
            <div class='card text-white bg-success'>
              <div class='card-body text-center'>
                <h5 class='card-title'>Health Records</h5>
                <h2>${recordsSnap.size}</h2>
              </div>
            </div>
          </div>
          <div class='col-12 col-md-4'>
            <div class='card text-white bg-danger'>
              <div class='card-body text-center'>
                <h5 class='card-title'>Critical Patients</h5>
                <h2>${criticalSnap.size}</h2>
              </div>
            </div>
          </div>
        </div>`;
    });
  }

  function loadUsers() {
    document.getElementById("title").innerText = "All Users";
    db.collection("users").get().then(snapshot => {
      let html = `<div class="table-responsive"><table class='table table-bordered'><tr><th>Name</th><th>Email</th><th>Role</th></tr>`;
      snapshot.forEach(doc => {
        const d = doc.data();
        html += `<tr><td>${d.name}</td><td>${d.email}</td><td>${d.role}</td></tr>`;
      });
      html += `</table></div>`;
      document.getElementById("dataSection").innerHTML = html;
    });
  }

  function loadAdmins() {
    document.getElementById("title").innerText = "Manage Admins";
    db.collection("users").get().then(snapshot => {
      let html = `<div class="table-responsive"><table class='table table-bordered'><tr><th>Name</th><th>Email</th><th>Role</th><th>Actions</th></tr>`;
      snapshot.forEach(doc => {
        const d = doc.data();
        html += `<tr>
          <td>${d.name}</td><td>${d.email}</td><td>${d.role}</td>
          <td>${d.role === "admin"
            ? `<button class='btn btn-sm btn-danger' onclick="changeRole('${doc.id}', 'patient')">Remove Admin</button>`
            : `<button class='btn btn-sm btn-success' onclick="changeRole('${doc.id}', 'admin')">Make Admin</button>`}
          </td></tr>`;
      });
      html += `</table></div>`;
      document.getElementById("dataSection").innerHTML = html;
    });
  }

  function changeRole(userId, role) {
    db.collection("users").doc(userId).update({ role }).then(() => {
      alert("Role updated");
      loadAdmins();
    });
  }

  function loadRecords() {
    document.getElementById("title").innerText = "All Health Records";
    db.collection("healthRecords").orderBy("recordedAt", "desc").get().then(snapshot => {
      let html = `<div class="table-responsive"><table class='table table-bordered'><tr><th>Date</th><th>Heart</th><th>Temp</th><th>Weight</th><th>Height</th></tr>`;
      snapshot.forEach(doc => {
        const d = doc.data();
        const date = d.recordedAt?.toDate().toLocaleDateString() ?? "N/A";
        html += `<tr><td>${date}</td><td>${d.heartRate}</td><td>${d.temperature}</td><td>${d.weight}</td><td>${d.height}</td></tr>`;
      });
      html += `</table></div>`;
      document.getElementById("dataSection").innerHTML = html;
    });
  }

  function loadCritical() {
    document.getElementById("title").innerText = "Critical Patients";
    db.collection("healthRecords").where("temperature", ">", 39).get().then(snapshot => {
      let html = `<div class="table-responsive"><table class='table table-bordered'><tr><th>Date</th><th>Heart</th><th>Temp</th><th>Weight</th><th>Height</th></tr>`;
      snapshot.forEach(doc => {
        const d = doc.data();
        const date = d.recordedAt?.toDate().toLocaleDateString() ?? "N/A";
        html += `<tr><td>${date}</td><td>${d.heartRate}</td><td>${d.temperature}</td><td>${d.weight}</td><td>${d.height}</td></tr>`;
      });
      html += `</table></div>`;
      document.getElementById("dataSection").innerHTML = html;
    });
  }

  function logout() {
    auth.signOut().then(() => window.location.href = "admin-login.html");
  }
</script>

</body>
</html>
